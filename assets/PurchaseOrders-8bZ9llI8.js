import{d as de,u as ne,a as r,x as H,q as re,c as k,b as I,e as l,H as O,w as t,k as ie,I as pe,G as C,K as me,J as ce,N as x,n as m,C as ve,o as c,l as d,D as fe,L as i,F as _e,g as be,i as ye,j as ge,M as Ie,O as B,R as J,Q as Ve,T as we,U as Ne,V as De,W as Ee,P as he,_ as Pe}from"./index-CWo0abK5.js";/* empty css                  *//* empty css                             *//* empty css                *//* empty css                 *//* empty css                        *//* empty css                *//* empty css               */import"./el-form-item-l0sNRNKZ.js";import{l as ke,u as Ce,s as xe,c as Ue}from"./purchase-BUPliIr5.js";import{a as Se}from"./supplier-CIHb-u2x.js";import{l as Ae}from"./product-B2KrNTYH.js";import"./http-CaWKIfWx.js";const qe={class:"purchase-orders-container"},ze={class:"header"},Te={style:{display:"flex","align-items":"center",gap:"10px"}},Oe={style:{"font-weight":"bold"}},Be={class:"dialog-footer"},Le=de({__name:"PurchaseOrders",setup(Fe){const E=ne().userInfo,L=r([]),F=r([]),h=r([]),U=r(!1),S=r(1),M=r(10),$=r(0),_=r(!1),v=r(!1),V=r(null),K=u=>{const e=h.value.find(n=>n.productId===u);return(e==null?void 0:e.price)??"-"},s=r({userId:E.userId,userName:E.userName,status:"待处理",items:[]}),w=r([]),A=r(0),q=async()=>{U.value=!0;try{const u=await ke({page:S.value,size:M.value});u.data.code==="200"?(L.value=u.data.data.records,$.value=u.data.data.total):m.error("获取采购订单失败")}catch{m.error("请求失败")}finally{U.value=!1}},Q=async()=>{const u=await Se();u.data.code==="200"?F.value=u.data.data:m.error("获取供应商失败")},R=async()=>{const u=await Ae();u.data.code==="200"?h.value=u.data.data:m.error("获取产品失败")},W=u=>{S.value=u,q()},X=()=>{_.value=!0,v.value=!1,V.value=null,w.value=[],s.value={userId:E.userId,userName:E.username,status:"待审核",items:[]}},Y=u=>{_.value=!0,v.value=!0,V.value=u.purchaseId,w.value=u.items.map(e=>e.productId),s.value={...u}},Z=async()=>{var e,n;if(!s.value.supplierId||((e=s.value.items)==null?void 0:e.length)===0||(n=s.value.items)!=null&&n.some(o=>o.quantity<=0||o.unitPrice<=0)){m.error("请填写完整的订单信息");return}const u={...s.value,total_amount:A.value};v.value&&V.value!==null&&(u.purchaseId=V.value);try{const o=v.value?await Ce(u):await xe(u);o.data.code==="200"?((u.status==="已完成"||u.status==="已取消")&&Ue(u.purchaseId,u.userId).then(f=>{f.data.code}),m.success(o.data.data),_.value=!1,q()):m.error(o.data.data)}catch{m.error("提交失败")}finally{v.value=!1,V.value=null}};H(()=>s.value.items,()=>{A.value=s.value.items.reduce((u,e)=>u+e.quantity*e.unitPrice,0)},{deep:!0}),H(w,u=>{s.value.items=u.map(e=>{var f;const n=h.value.find(b=>b.productId===e),o=(f=s.value.items)==null?void 0:f.find(b=>b.productId===e);return{productId:e,productName:(n==null?void 0:n.productName)||"",quantity:(o==null?void 0:o.quantity)||1,unitPrice:(o==null?void 0:o.unitPrice)||1}})});const P=r(!1),p=r({purchaseId:0,userId:0,userName:"",supplierId:0,supplierName:"",orderDate:"",totalAmount:0,status:"",items:[]}),ee=u=>{p.value={...u},P.value=!0};return re(()=>{Q(),R(),q()}),(u,e)=>{const n=ie,o=fe,f=_e,b=ve,le=me,ae=ge,y=ye,N=Ve,z=Ie,T=Ee,j=he,te=be,G=ce,g=Ne,ue=we,se=De,oe=pe;return c(),k(x,null,[I("div",qe,[I("div",ze,[e[9]||(e[9]=I("h2",null,"采购订单管理",-1)),l(n,{type:"primary",onClick:X},{default:t(()=>e[8]||(e[8]=[d("创建订单")])),_:1})]),O((c(),C(b,{data:L.value,style:{width:"100%",height:"90%"},"row-style":{height:"70px"}},{default:t(()=>[l(o,{prop:"purchaseId",label:"订单ID"}),l(o,{prop:"userName",label:"操作人"}),l(o,{prop:"supplierName",label:"供应商ID"}),l(o,{prop:"orderDate",label:"订单日期"}),l(o,{prop:"totalAmount",label:"总金额"},{default:t(a=>[d(" ¥"+i(a.row.totalAmount),1)]),_:1}),l(o,{prop:"status",label:"状态"},{default:t(a=>[l(f,{type:a.row.status==="已完成"?"success":"warning"},{default:t(()=>[d(i(a.row.status),1)]),_:2},1032,["type"])]),_:1}),l(o,{label:"操作",width:"300",align:"center"},{default:t(a=>[l(n,{size:"small",type:"info",onClick:D=>ee(a.row)},{default:t(()=>e[10]||(e[10]=[d("查看详情")])),_:2},1032,["onClick"]),l(n,{size:"small",type:"info",onClick:D=>Y(a.row)},{default:t(()=>e[11]||(e[11]=[d("编辑")])),_:2},1032,["onClick"])]),_:1})]),_:1},8,["data"])),[[oe,U.value]]),l(le,{"current-page":S.value,"page-size":M.value,total:$.value,background:"",style:{"margin-top":"5px"},layout:"prev, pager, next",onCurrentChange:W},null,8,["current-page","page-size","total"])]),l(G,{modelValue:_.value,"onUpdate:modelValue":e[5]||(e[5]=a=>_.value=a),title:v.value?"编辑采购订单":"新增采购订单",width:"600px"},{footer:t(()=>[I("div",Be,[l(n,{onClick:e[4]||(e[4]=a=>_.value=!1)},{default:t(()=>e[14]||(e[14]=[d("取消")])),_:1}),l(n,{type:"primary",onClick:Z},{default:t(()=>e[15]||(e[15]=[d("提交")])),_:1})])]),default:t(()=>[l(te,{model:s.value,"label-width":"100px",disabled:s.value.status==="已取消"},{default:t(()=>[l(y,{label:"当前操作人"},{default:t(()=>[l(ae,{modelValue:s.value.userName,"onUpdate:modelValue":e[0]||(e[0]=a=>s.value.userName=a),disabled:""},null,8,["modelValue"])]),_:1}),l(y,{label:"产品选择"},{default:t(()=>[l(z,{modelValue:w.value,"onUpdate:modelValue":e[1]||(e[1]=a=>w.value=a),multiple:"",placeholder:"选择产品",style:{width:"100%"},disabled:s.value.status==="已完成"||s.value.status==="已取消"},{default:t(()=>[(c(!0),k(x,null,B(h.value,a=>O((c(),C(N,{key:a.productId,label:a.productName,value:a.productId},null,8,["label","value"])),[[J,a.status==="可用"||a.status==="售罄"]])),128))]),_:1},8,["modelValue","disabled"])]),_:1}),(c(!0),k(x,null,B(s.value.items,a=>(c(),C(y,{key:a.productId,label:a.productName},{default:t(()=>[I("div",Te,[l(T,null,{default:t(()=>e[12]||(e[12]=[d("数量")])),_:1}),l(j,{modelValue:a.quantity,"onUpdate:modelValue":D=>a.quantity=D,min:1,placeholder:"数量",style:{width:"130px"},disabled:s.value.status==="已完成"||s.value.status==="已取消"},null,8,["modelValue","onUpdate:modelValue","disabled"]),l(T,null,{default:t(()=>e[13]||(e[13]=[d("单价")])),_:1}),l(j,{modelValue:a.unitPrice,"onUpdate:modelValue":D=>a.unitPrice=D,min:.01,step:.01,placeholder:"采购单价",disabled:s.value.status==="已完成"||s.value.status==="已取消"},null,8,["modelValue","onUpdate:modelValue","disabled"]),l(T,{type:"info",style:{"white-space":"nowrap"}},{default:t(()=>[d(" 售价：¥"+i(K(a.productId)),1)]),_:2},1024)])]),_:2},1032,["label"]))),128)),l(y,{label:"供应商"},{default:t(()=>[l(z,{modelValue:s.value.supplierId,"onUpdate:modelValue":e[2]||(e[2]=a=>s.value.supplierId=a),placeholder:"请选择供应商",style:{width:"100%"},disabled:s.value.status==="已完成"||s.value.status==="已取消"},{default:t(()=>[(c(!0),k(x,null,B(F.value,a=>(c(),C(N,{key:a.supplierId,label:a.supplierName,value:a.supplierId},null,8,["label","value"]))),128))]),_:1},8,["modelValue","disabled"])]),_:1}),O(l(y,{label:"状态"},{default:t(()=>[l(z,{modelValue:s.value.status,"onUpdate:modelValue":e[3]||(e[3]=a=>s.value.status=a),placeholder:"请选择状态",style:{width:"100%"}},{default:t(()=>[l(N,{label:"待审核",value:"待审核"}),l(N,{label:"已完成",value:"已完成"}),l(N,{label:"已取消",value:"已取消"})]),_:1},8,["modelValue"])]),_:1},512),[[J,v.value]]),l(y,{label:"总金额"},{default:t(()=>[I("div",Oe,"¥"+i(A.value),1)]),_:1})]),_:1},8,["model","disabled"])]),_:1},8,["modelValue","title"]),l(G,{modelValue:P.value,"onUpdate:modelValue":e[7]||(e[7]=a=>P.value=a),title:"订单详情",width:"700px"},{footer:t(()=>[l(n,{onClick:e[6]||(e[6]=a=>P.value=!1)},{default:t(()=>e[17]||(e[17]=[d("关闭")])),_:1})]),default:t(()=>[l(ue,{column:2,border:""},{default:t(()=>[l(g,{label:"订单ID"},{default:t(()=>[d(i(p.value.purchaseId),1)]),_:1}),l(g,{label:"操作人"},{default:t(()=>[d(i(p.value.userName),1)]),_:1}),l(g,{label:"供应商"},{default:t(()=>[d(i(p.value.supplierName),1)]),_:1}),l(g,{label:"下单日期"},{default:t(()=>[d(i(p.value.orderDate),1)]),_:1}),l(g,{label:"状态"},{default:t(()=>[l(f,{type:p.value.status==="已完成"?"success":"warning"},{default:t(()=>[d(i(p.value.status),1)]),_:1},8,["type"])]),_:1}),l(g,{label:"总金额"},{default:t(()=>[d("¥"+i(p.value.totalAmount),1)]),_:1})]),_:1}),l(se,null,{default:t(()=>e[16]||(e[16]=[d("商品列表")])),_:1}),l(b,{data:p.value.items,size:"small",border:""},{default:t(()=>[l(o,{prop:"productName",label:"商品名"}),l(o,{prop:"quantity",label:"数量"}),l(o,{prop:"unitPrice",label:"单价"})]),_:1},8,["data"])]),_:1},8,["modelValue"])],64)}}}),ll=Pe(Le,[["__scopeId","data-v-ed0564a9"]]);export{ll as default};
